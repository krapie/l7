apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.yorkie.name }}-l7
  namespace: {{ .Values.l7.namespace }}
  labels:
    app: l7
    app.kubernetes.io/name: l7
    app.kubernetes.io/instance: l7
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: l7
    app.kubernetes.io/managed-by: helm
spec:
  {{ if not .Values.yorkie.autoscaling.enabled }}
  replicas: 1
  {{ end }}
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app.kubernetes.io/instance: l7
  template:
    metadata:
      labels:
        app: l7
        app.kubernetes.io/instance: l7
    spec:
      automountServiceAccountToken: true
      serviceAccountName: l7
      containers:
      - name: l7
        image: "{{ .Values.l7.image.repository }}:{{ .Values.l7.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.l7.image.pullPolicy }}
        args: [
            "--service-discovery-mode",
            "k8s",
            "--target-filter",
            "yorkie",
            "--maglev-hash-key",
            "X-Shard-Key"
        ]
        ports:
          - containerPort: 80
        resources: {}
